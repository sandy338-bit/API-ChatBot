<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FloatChat AI</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      /* --- üé® General Styling & Variables --- */
      :root {
        --primary-bg: #f0f4f8;
        --secondary-bg: #ffffff;
        --accent-color: #0066ff;
        --accent-color-light: #0052cc;
        --text-color: #1f2937;
        --light-text-color: #6b7280;
        --border-color: #e5e7eb;
        --shadow-color: rgba(0, 0, 0, 0.05);
        --bot-message-bg: #f3f4f6;
        --user-message-bg: #0066ff;
        --user-message-text: #ffffff;

        /* Dark Theme Variables */
        --dark-bg-primary: #111827;
        --dark-bg-secondary: #1f2937;
        --dark-bg-tertiary: #374151;
        --dark-border-color: #374151;
        --dark-text-primary: #f9fafb;
        --dark-text-secondary: #9ca3af;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      /* --- Gradient Animation --- */
      @keyframes moveGradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      body {
        margin: 0;
        /* --- Purple, Blue, Pink Gradient --- */
        background: linear-gradient(
          125deg,
          #6a11cb,
          /* Darker Purple */ #2575fc,
          /* Bright Blue */ #a855f7,
          /* Medium Purple */ #ec4899,
          /* Pink */ #7e22ce,
          /* Deep Purple */ #3b82f6 /* Lighter Blue */
        );
        background-size: 400% 400%;
        animation: moveGradient 18s ease infinite;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: #333;
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition: background-color 0.3s ease;
      }

      /* --- üìñ Chat History Sidebar --- */
      .history-sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 280px;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.2) 0%,
            rgba(255, 255, 255, 0.05) 100%
          ),
          rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-right: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out, background-color 0.3s ease,
          border-color 0.3s ease;
        z-index: 2000;
        display: flex;
        flex-direction: column;
      }
      .history-sidebar.open {
        transform: translateX(0);
      }
      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        position: relative; /* For glass separator */
        flex-shrink: 0; /* NEW: Prevent shrinking */
      }
      .history-header::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }
      .history-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-color);
        transition: color 0.3s ease;
      }
      .close-history-btn {
        background: transparent;
        border: none;
        color: var(--text-color);
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        opacity: 0.7;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .close-history-btn:hover {
        opacity: 1;
        transform: scale(1.1);
      }
      .history-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 16px;
      }
      .history-content::-webkit-scrollbar {
        width: 6px;
      }
      .history-content::-webkit-scrollbar-track {
        background: transparent;
      }
      .history-content::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 20px;
      }
      .history-content ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .history-content li a {
        display: block;
        padding: 10px 14px;
        text-decoration: none;
        color: #333;
        border-radius: 8px;
        font-size: 15px;
        transition: background-color 0.2s ease, color 0.3s ease;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .history-content li a:hover {
        background-color: rgba(255, 255, 255, 0.3);
      }

      /* --- NEW: History Footer --- */
      .history-footer {
        padding: 16px;
        position: relative; /* For glass separator */
        flex-shrink: 0; /* Prevent shrinking */
      }
      .history-footer::before {
        content: "";
        position: absolute;
        top: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }
      #history-clear-chat-btn {
        width: 100%;
        padding: 10px 14px;
        font-size: 15px;
        font-weight: 500;
        color: #ff4d4d; /* Red text for destructive action */
        background: rgba(255, 100, 100, 0.15);
        border: 1px solid rgba(255, 100, 100, 0.2);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      #history-clear-chat-btn:hover {
        background: rgba(255, 100, 100, 0.3);
        border-color: rgba(255, 100, 100, 0.4);
        color: #ff2a2a;
      }
      /* --- End History Footer --- */

      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        z-index: 1999;
        backdrop-filter: blur(2px);
      }
      .sidebar-overlay.open {
        display: block;
      }
      /* --- End of History Sidebar --- */

      /* --- History Toggle Button --- */
      .history-toggle-btn {
        position: absolute;
        top: 24px;
        left: 24px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-color);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s ease;
        z-index: 100;
      }
      .history-toggle-btn:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: scale(1.05);
      }

      /* --- üèóÔ∏è Main Layout Structure --- */
      .container {
        display: flex;
        width: 100%;
        height: 100%;
        max-width: 100%x;
        max-height: 100%;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.25) 0%,
            rgba(255, 255, 255, 0.05) 100%
          ),
          rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.18);
        overflow: hidden;
        transition: background-color 0.3s ease, border-color 0.3s ease,
          box-shadow 0.3s ease;
      }
      .main-content {
        width: 55%;
        display: flex;
        flex-direction: column;
        padding: 24px;
        overflow: hidden;
        position: relative; /* Added for history button */
      }
      .sidebar {
        width: 45%;
        display: flex;
        flex-direction: column;
        background-color: transparent;
        position: relative; /* Needed for separator */
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      /* --- Glass Vertical Separator --- */
      .sidebar::before {
        content: "";
        position: absolute;
        left: -2px;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 95%;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      /* --- üí¨ Chat Area --- */
      .chat-header {
        padding: 20px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: transparent;
        transition: background-color 0.3s ease, border-color 0.3s ease;
        position: relative; /* ADDED */
      }
      .chat-header h1 {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
        margin-left: 12px;
        color: var(--text-color);
        transition: color 0.3s ease;
      }

      /* --- Dropdown Menu Styles --- */
      .chat-title-menu {
        position: relative;
        display: flex;
      }
      .chat-title-trigger {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .dropdown-menu {
        display: none;
        position: absolute;
        top: calc(100% + 10px);
        left: 0;
        z-index: 1000;
        min-width: 300px;
        border-radius: 12px;
        padding: 8px;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.4) 0%,
            rgba(255, 255, 255, 0.2) 100%
          ),
          rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: background-color 0.3s ease, border-color 0.3s ease,
          box-shadow 0.3s ease;
      }
      .dropdown-item {
        display: block;
        width: 100%;
        background: transparent;
        border: none;
        padding: 10px 12px;
        text-align: left;
        color: #333;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        transition: background-color 0.2s ease, color 0.3s ease;
      }
      .dropdown-item i {
        margin-right: 10px;
        font-size: 16px;
        width: 20px;
        display: inline-block;
        text-align: center;
      }
      .dropdown-item span i {
        font-size: 14px;
        width: 20px;
      }
      .dropdown-item:hover {
        background-color: rgba(255, 255, 255, 0.3);
      }
      .dropdown-divider {
        height: 1px;
        background-color: rgba(255, 255, 255, 0.2);
        margin: 8px 0;
        transition: background-color 0.3s ease;
      }
      .dropdown-header {
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        color: #555;
        letter-spacing: 0.5px;
        transition: color 0.3s ease;
      }

      .chat-window {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .chat-window::-webkit-scrollbar {
        width: 6px;
      }
      .chat-window::-webkit-scrollbar-track {
        background: transparent;
      }
      .chat-window::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 20px;
      }
      .message {
        max-width: 80%;
        padding: 12px 18px;
        border-radius: 20px;
        line-height: 1.5;
        word-wrap: break-word;
      }
      .user-message {
        background-color: var(--user-message-bg);
        color: var(--user-message-text);
        align-self: flex-end;
        border-bottom-right-radius: 5px;
      }
      .bot-message {
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.4) 0%,
            rgba(255, 255, 255, 0.2) 100%
          ),
          rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-color);
        align-self: flex-start;
        border-bottom-left-radius: 5px;
        transition: background-color 0.3s ease, border-color 0.3s ease,
          color 0.3s ease;
      }

      /* --- üí° Suggestion & Input Area --- */
      .suggestion-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px 20px;
        background: transparent;
        transition: background-color 0.3s ease, border-color 0.3s ease;
        position: relative; /* ADDED */
      }
      .suggestion-bar button {
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.4) 0%,
            rgba(255, 255, 255, 0.2) 100%
          ),
          rgba(255, 255, 255, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #374151;
        border-radius: 9999px;
        padding: 6px 14px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
      }
      .suggestion-bar button:hover {
        background: rgba(255, 255, 255, 0.4);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
      }
      .suggestion-bar button:active {
        transform: scale(0.97);
      }
      .input-area {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        background: transparent;
        transition: background-color 0.3s ease, border-color 0.3s ease;
        position: relative; /* ADDED */
      }

      /* --- Glass Horizontal Separators --- */
      .chat-header::after,
      .suggestion-bar::before,
      .input-area::before {
        content: "";
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }
      .chat-header::after {
        bottom: -2px; /* Position at the bottom */
      }
      .suggestion-bar::before,
      .input-area::before {
        top: -2px; /* Position at the top */
      }
      /* --- End of New Separators --- */

      input[type="text"] {
        flex-grow: 1;
        padding: 12px 20px;
        border-radius: 24px;
        font-size: 16px;
        outline: none;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.3) 0%,
            rgba(255, 255, 255, 0.1) 100%
          ),
          rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #111;
        transition: all 0.3s;
      }
      input[type="text"]::placeholder {
        color: rgba(0, 0, 0, 0.5);
        transition: color 0.3s ease;
      }
      input[type="text"]:focus {
        border-color: var(--accent-color);
        background-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.15);
      }
      .input-area #sendButton {
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        margin-left: 8px; /* MODIFIED */
        cursor: pointer;
        font-size: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s ease;
      }
      .input-area #sendButton:hover {
        background-color: var(--accent-color-light);
        transform: scale(1.05);
      }

      /* --- NEW: File Input Style --- */
      #fileInput {
        display: none;
      }
      .input-area .attach-btn {
        margin-left: 10px; /* Space from input */
      }
      .input-area .mic-btn {
        margin-left: 8px; /* Space from attach */
      }

      /* --- NEW: Glassmorphic Button Base (for Mic & Attach) --- */
      .input-area .mic-btn,
      .input-area .attach-btn {
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.4) 0%,
            rgba(255, 255, 255, 0.2) 100%
          ),
          rgba(255, 255, 255, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #374151;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .input-area .mic-btn:hover,
      .input-area .attach-btn:hover {
        background: rgba(255, 255, 255, 0.4);
        border-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
      }
      .input-area .mic-btn:active,
      .input-area .attach-btn:active {
        transform: scale(0.95);
      }

      /* --- Mic button recording state --- */
      .input-area .mic-btn.is-recording {
        background: #ff4d4d;
        color: white;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(255, 77, 77, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 77, 77, 0);
        }
      }
      /* --- End Mic/File Button Style --- */

      /* --- üìä Visualization Area --- */
      .info-panel {
        /* Added padding-top to make space for history button */
        padding-top: 40px;
      }
      .info-panel h2 {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
        transition: color 0.3s ease;
      }
      .info-panel p {
        color: #444;
        font-size: 15px;
        margin-top: 0;
        transition: color 0.3s ease;
      }
      .fleet-status {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 20px;
      }
      .status-card {
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.3) 0%,
            rgba(255, 255, 255, 0.1) 100%
          ),
          rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease,
          background-color 0.3s ease, border-color 0.3s ease;
      }
      .status-card:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
      }
      .status-card h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 500;
        color: #444;
        transition: color 0.3s ease;
      }
      .status-card p {
        margin: 8px 0 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text-color);
        transition: color 0.3s ease;
      }
      .visualization-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        border-radius: 12px;
        min-height: 0;
      }
      .chart-section {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 12px;
        padding: 10px;
        min-height: 0;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.3) 0%,
            rgba(255, 255, 255, 0.1) 100%
          ),
          rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: background-color 0.3s ease, border-color 0.3s ease;
        position: relative; /* ADDED FOR ZOOM BUTTONS */
      }
      #plot-container {
        width: 100%;
        height: 100%;
      }
      .plot-placeholder {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #444;
        text-align: center;
        font-size: 15px;
        transition: color 0.3s ease;
      }
      .plot-placeholder svg {
        width: 120px;
        height: 120px;
        margin-bottom: 16px;
        opacity: 0.7;
      }
      .plot-placeholder p {
        color: #444;
        margin: 0;
      }

      /* --- NEW: Zoom Controls Styling --- */
      .zoom-controls {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 100; /* Above the plot */
        display: flex;
        flex-direction: column; /* Stack vertically */
        gap: 8px;
      }
      .zoom-controls button {
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.4) 0%,
            rgba(255, 255, 255, 0.2) 100%
          ),
          rgba(255, 255, 255, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #374151;
        border-radius: 50%; /* Round buttons */
        width: 32px;
        height: 32px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        display: flex; /* Center icon */
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .zoom-controls button:hover {
        background: rgba(255, 255, 255, 0.4);
        border-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
      }
      .zoom-controls button:active {
        transform: scale(0.95);
      }
      /* --- End of New Zoom Controls Styling --- */

      /* Modern Toggle Buttons */
      .toggle-buttons {
        display: flex;
        justify-content: center;
        margin-bottom: 16px;
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 20px;
        padding: 4px;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
        transition: background-color 0.3s ease;
      }
      .toggle-buttons button {
        background-color: transparent;
        color: #495057;
        border: none;
        border-radius: 16px;
        padding: 6px 16px;
        margin: 0;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        height: auto;
        width: auto;
      }
      .toggle-buttons button.active {
        background-color: var(--secondary-bg);
        color: var(--accent-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .toggle-buttons button:not(.active):hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      /* --- Theme Toggle Buttons (NEW GLASSMORPHIC STYLE) --- */
      .theme-toggle-buttons {
        /* NEW: Glassmorphic design */
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.2) 0%,
            rgba(255, 255, 255, 0.05) 100%
          ),
          rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 20px;
        padding: 4px;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: row; /* <-- MODIFICATION: Explicitly set to horizontal */
      }
      .theme-btn {
        background: transparent;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        color: #f0f0f0; /* Light color for default dark glass */
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        margin: 0 2px;
      }
      .theme-btn.active {
        background: rgba(255, 255, 255, 0.3); /* Brighter glass for active */
        color: #ffffff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .theme-btn:not(.active):hover {
        background: rgba(255, 255, 255, 0.15); /* Subtle hover */
      }

      /* --- ‚öôÔ∏è Utilities --- */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: var(--accent-color);
        animation: spin 1s linear infinite;
        display: none;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* --- üì± Responsive Design --- */
      @media (max-width: 1024px) {
        body {
          height: auto;
          padding: 1rem;
        }
        .container {
          flex-direction: column;
          height: auto;
          max-height: none;
          width: 100%;
        }
        .main-content,
        .sidebar {
          width: 100%;
          height: 50vh;
        }
        .sidebar {
          border-left: none;
          position: relative;
        }
        /* Hide vertical separator on mobile */
        .sidebar::before {
          display: none;
        }
        /* Position top separator for mobile */
        .sidebar::before {
          content: "";
          position: absolute;
          left: 50%;
          transform: translateX(-50%);
          width: 95%;
          height: 4px;
          background: rgba(255, 255, 255, 0.2);
          border-radius: 4px;
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
          transition: all 0.3s ease;
          top: -2px; /* Position at the top */
        }
        /* Reposition history button on mobile */
        .history-toggle-btn {
          top: 16px;
          left: 16px;
        }
        .info-panel {
          padding-top: 30px;
        }
      }

      /*
      ===============================================
      --- ‚òÄÔ∏è LIGHT THEME OVERRIDES ---
      ===============================================
      */
      .light-theme body {
        background: var(--primary-bg);
        animation: none;
      }
      .light-theme .container {
        /* MODIFIED: Re-added glass effect */
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        box-shadow: 0 10px 35px var(--shadow-color);
        border: 1px solid var(--border-color);
      }
      .light-theme .sidebar {
        /* MODIFIED: Re-added glass effect */
        background-color: rgba(248, 249, 250, 0.75);
        border-left: 1px solid var(--border-color);
      }
      .light-theme .sidebar::before {
        display: none; /* Hide glass separator */
      }
      .light-theme .chat-header {
        background: transparent; /* MODIFIED: Was var(--secondary-bg) */
        border-bottom: 1px solid var(--border-color); /* Restore border */
      }
      .light-theme .chat-header::after {
        display: none; /* Hide glass separator */
      }
      .light-theme .chat-header h1 {
        color: var(--text-color);
      }
      /* Light theme dropdown */
      .light-theme .dropdown-menu {
        /* MODIFIED: Re-added glass effect */
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 5px 15px var(--shadow-color);
        border: 1px solid var(--border-color);
      }
      .light-theme .dropdown-item {
        color: var(--text-color);
      }
      .light-theme .dropdown-item:hover {
        background-color: var(--bot-message-bg);
      }
      .light-theme .dropdown-divider {
        background-color: var(--border-color);
      }
      .light-theme .dropdown-header {
        color: var(--light-text-color);
      }
      .light-theme .bot-message {
        /* MODIFIED: Made slightly translucent */
        background: rgba(243, 244, 246, 0.85);
        color: var(--text-color);
        border: 1px solid var(--border-color);
      }
      .light-theme .suggestion-bar {
        background: transparent; /* MODIFIED: Was #f8f9fa */
        border-top: 1px solid var(--border-color); /* Restore border */
      }
      .light-theme .suggestion-bar::before {
        display: none; /* Hide glass separator */
      }
      .light-theme .suggestion-bar button {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        color: #374151;
      }
      .light-theme .suggestion-bar button:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: translateY(-1px);
      }
      .light-theme .input-area {
        background: transparent; /* MODIFIED: Was var(--secondary-bg) */
        border-top: 1px solid var(--border-color); /* Restore border */
      }
      .light-theme .input-area::before {
        display: none; /* Hide glass separator */
      }
      .light-theme input[type="text"] {
        background-color: #f9fafb;
        border: 1px solid var(--border-color);
        color: var(--text-color);
      }
      .light-theme input[type="text"]::placeholder {
        color: var(--light-text-color);
      }
      .light-theme input[type="text"]:focus {
        background-color: var(--secondary-bg);
      }
      .light-theme .info-panel h2 {
        color: var(--text-color);
      }
      .light-theme .info-panel p,
      .light-theme .status-card h3 {
        color: var(--light-text-color);
      }
      .light-theme .status-card p {
        color: var(--text-color);
      }
      .light-theme .plot-placeholder p {
        color: var(--light-text-color);
      }
      .light-theme .plot-placeholder svg {
        opacity: 1;
        fill: #e0e7ff;
        stroke: #6366f1;
      }
      .light-theme .status-card {
        /* MODIFIED: Made slightly translucent */
        background-color: rgba(249, 250, 251, 0.8);
        border: 1px solid var(--border-color);
      }
      .light-theme .status-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .light-theme .chart-section {
        /* MODIFIED: Made slightly translucent */
        background-color: rgba(249, 250, 251, 0.8);
        border: 1px solid var(--border-color);
      }

      /* --- Light Theme Zoom, Mic & Attach --- */
      .light-theme .zoom-controls button,
      .light-theme .input-area .mic-btn,
      .light-theme .input-area .attach-btn {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        color: #374151;
        box-shadow: 0 1px 3px var(--shadow-color);
      }
      .light-theme .zoom-controls button:hover,
      .light-theme .input-area .mic-btn:hover,
      .light-theme .input-area .attach-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
      }
      .light-theme .input-area .mic-btn.is-recording {
        background: #d93030;
        color: white;
        animation-name: none; /* Disable pulse if too jarring on light bg */
      }
      /* --- End Light Theme Zoom, Mic & Attach --- */

      .light-theme .toggle-buttons {
        background-color: #e9ecef;
      }
      .light-theme .toggle-buttons button:not(.active):hover {
        background-color: #dee2e6;
      }

      /* --- Light Theme Toggle (NEW) --- */
      .light-theme .theme-toggle-buttons {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-color);
        box-shadow: 0 1px 3px var(--shadow-color);
      }
      .light-theme .theme-btn {
        color: #495057;
      }
      .light-theme .theme-btn.active {
        background: var(--secondary-bg); /* Solid active state */
        color: var(--accent-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .light-theme .theme-btn:not(.active):hover {
        background: rgba(0, 0, 0, 0.05); /* Subtle solid hover */
      }

      /* Restore top border for mobile light theme */
      @media (max-width: 1024px) {
        .light-theme .sidebar {
          border-top: 1px solid var(--border-color);
        }
        .light-theme .sidebar::before {
          display: none;
        }
      }

      /* --- Light Theme History --- */
      .light-theme .history-sidebar {
        /* MODIFIED: Re-added glass effect */
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-right: 1px solid var(--border-color);
        box-shadow: 0 4px 30px var(--shadow-color);
      }
      .light-theme .history-header {
        border-bottom: 1px solid var(--border-color);
      }
      .light-theme .history-header::after {
        display: none; /* Hide glass separator */
      }
      .light-theme .history-header h2 {
        color: var(--text-color);
      }
      .light-theme .close-history-btn {
        color: var(--text-color);
      }
      .light-theme .history-content li a {
        color: var(--text-color);
      }
      .light-theme .history-content li a:hover {
        background-color: var(--bot-message-bg);
      }
      .light-theme .history-toggle-btn {
        background: var(--secondary-bg);
        border-color: var(--border-color);
        color: var(--text-color);
        box-shadow: 0 2px 4px var(--shadow-color);
      }
      .light-theme .history-toggle-btn:hover {
        background: var(--bot-message-bg);
      }
      /* NEW: Light theme history footer */
      .light-theme .history-footer {
        border-top: 1px solid var(--border-color);
      }
      .light-theme .history-footer::before {
        display: none;
      }
      .light-theme #history-clear-chat-btn {
        color: #d93030;
        background: #fff0f0;
        border: 1px solid #ffcccc;
      }
      .light-theme #history-clear-chat-btn:hover {
        background: #ffe5e5;
        border-color: #ffb8b8;
        color: #d93030;
      }
      /* --- End Light Theme History --- */

      /*
      ===============================================
      --- üåô DARK THEME OVERRIDES ---
      ===============================================
      */
      .dark-theme body {
        background: var(--dark-bg-primary);
        animation: none;
      }
      .dark-theme .container {
        /* MODIFIED: Re-added glass effect */
        background: rgba(31, 41, 55, 0.75);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        box-shadow: 0 10px 35px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--dark-border-color);
      }
      .dark-theme .sidebar {
        /* MODIFIED: Re-added glass effect */
        background-color: rgba(17, 24, 39, 0.75);
        border-left: 1px solid var(--dark-border-color); /* Restore border */
      }
      .dark-theme .sidebar::before {
        display: none; /* Hide glass separator */
      }
      .dark-theme .chat-header {
        background: transparent;
        border-bottom: 1px solid var(--dark-border-color); /* Restore border */
      }
      .dark-theme .chat-header::after {
        display: none; /* Hide glass separator */
      }
      .dark-theme .chat-header h1 {
        color: var(--dark-text-primary);
      }
      /* Dark theme dropdown */
      .dark-theme .dropdown-menu {
        /* MODIFIED: Re-added glass effect */
        background: rgba(55, 65, 81, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--dark-border-color);
      }
      .dark-theme .dropdown-item {
        color: var(--dark-text-primary);
      }
      .dark-theme .dropdown-item:hover {
        background-color: #4b5563;
      }
      .dark-theme .dropdown-divider {
        background-color: var(--dark-border-color);
      }
      .dark-theme .dropdown-header {
        color: var(--dark-text-secondary);
      }
      .dark-theme .bot-message {
        /* MODIFIED: Made slightly translucent */
        background: rgba(55, 65, 81, 0.85);
        color: var(--dark-text-primary);
        border: 1px solid var(--dark-border-color);
      }
      .dark-theme .suggestion-bar {
        background: transparent;
        border-top: 1px solid var(--dark-border-color); /* Restore border */
      }
      .dark-theme .suggestion-bar::before {
        display: none; /* Hide glass separator */
      }
      .dark-theme .suggestion-bar button {
        background: var(--dark-bg-tertiary);
        border: 1px solid var(--dark-bg-tertiary);
        color: var(--dark-text-primary);
      }
      .dark-theme .suggestion-bar button:hover {
        background: #4b5563;
        transform: translateY(-1px);
      }
      .dark-theme .input-area {
        background: transparent;
        border-top: 1px solid var(--dark-border-color); /* Restore border */
      }
      .dark-theme .input-area::before {
        display: none; /* Hide glass separator */
      }
      .dark-theme input[type="text"] {
        background-color: var(--dark-bg-tertiary);
        border: 1px solid var(--dark-border-color);
        color: var(--dark-text-primary);
      }
      .dark-theme input[type="text"]::placeholder {
        color: var(--dark-text-secondary);
      }
      .dark-theme input[type="text"]:focus {
        background-color: var(--dark-bg-tertiary);
      }
      .dark-theme .info-panel h2,
      .dark-theme .status-card p {
        color: var(--dark-text-primary);
      }
      .dark-theme .info-panel p,
      .dark-theme .status-card h3 {
        color: var(--dark-text-secondary);
      }
      .dark-theme .plot-placeholder p {
        color: var(--dark-text-secondary);
      }
      .dark-theme .plot-placeholder svg {
        opacity: 0.8;
        fill: #374151;
        stroke: #9ca3af;
      }
      .dark-theme .status-card {
        /* MODIFIED: Made slightly translucent */
        background-color: rgba(55, 65, 81, 0.8);
        border: 1px solid var(--dark-bg-tertiary);
      }
      .dark-theme .status-card:hover {
        transform: translateY(-3px);
        background-color: #4b5563;
        box-shadow: none;
      }
      .dark-theme .chart-section {
        /* MODIFIED: Made slightly translucent */
        background-color: rgba(55, 65, 81, 0.8);
        border: 1px solid var(--dark-bg-tertiary);
      }

      /* --- Dark Theme Zoom, Mic & Attach --- */
      .dark-theme .zoom-controls button,
      .dark-theme .input-area .mic-btn,
      .dark-theme .input-area .attach-btn {
        background: var(--dark-bg-tertiary);
        border: 1px solid var(--dark-bg-tertiary);
        color: var(--dark-text-primary);
      }
      .dark-theme .zoom-controls button:hover,
      .dark-theme .input-area .mic-btn:hover,
      .dark-theme .input-area .attach-btn:hover {
        background: #4b5563;
      }
      .dark-theme .input-area .mic-btn.is-recording {
        background: #ff7a7a;
        color: var(--dark-text-primary);
      }
      /* --- End Dark Theme Zoom, Mic & Attach --- */

      .dark-theme .toggle-buttons {
        background-color: var(--dark-bg-primary);
      }
      .dark-theme .toggle-buttons button {
        color: var(--dark-text-secondary);
      }
      .dark-theme .toggle-buttons button.active {
        background-color: var(--dark-bg-tertiary);
      }
      .dark-theme .toggle-buttons button:not(.active):hover {
        background-color: var(--dark-bg-tertiary);
      }

      /* --- Dark Theme Toggle (NEW) --- */
      .dark-theme .theme-toggle-buttons {
        background: rgba(31, 41, 55, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid var(--dark-border-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      .dark-theme .theme-btn {
        color: var(--dark-text-secondary);
      }
      .dark-theme .theme-btn.active {
        background: var(--dark-bg-tertiary); /* Solid active state */
        color: var(--dark-text-primary);
        box-shadow: none;
      }
      .dark-theme .theme-btn:not(.active):hover {
        background: rgba(255, 255, 255, 0.05); /* Subtle solid hover */
      }

      /* Restore top border for mobile dark theme */
      @media (max-width: 1024px) {
        .dark-theme .sidebar {
          border-top: 1px solid var(--dark-border-color);
        }
        .dark-theme .sidebar::before {
          display: none;
        }
      }

      /* --- Dark Theme History --- */
      .dark-theme .history-sidebar {
        /* MODIFIED: Re-added glass effect */
        background: rgba(17, 24, 39, 0.8);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-right: 1px solid var(--dark-border-color);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
      }
      .dark-theme .history-header {
        border-bottom: 1px solid var(--dark-border-color);
      }
      .dark-theme .history-header::after {
        display: none; /* Hide glass separator */
      }
      .dark-theme .history-header h2 {
        color: var(--dark-text-primary);
      }
      .dark-theme .close-history-btn {
        color: var(--dark-text-primary);
      }
      .dark-theme .history-content li a {
        color: var(--dark-text-primary);
      }
      .dark-theme .history-content li a:hover {
        background-color: var(--dark-bg-tertiary);
      }
      .dark-theme .history-toggle-btn {
        background: var(--dark-bg-secondary);
        border-color: var(--dark-border-color);
        color: var(--dark-text-primary);
      }
      .dark-theme .history-toggle-btn:hover {
        background: var(--dark-bg-tertiary);
      }
      /* NEW: Dark theme history footer */
      .dark-theme .history-footer {
        border-top: 1px solid var(--dark-border-color);
      }
      .dark-theme .history-footer::before {
        display: none;
      }
      .dark-theme #history-clear-chat-btn {
        color: #ff7a7a;
        background: rgba(255, 82, 82, 0.15);
        border: 1px solid rgba(255, 82, 82, 0.2);
      }
      .dark-theme #history-clear-chat-btn:hover {
        background: rgba(255, 82, 82, 0.25);
        border-color: rgba(255, 82, 82, 0.3);
        color: #ff9494;
      }
      /* --- End Dark Theme History --- */
    </style>
  </head>
  <body>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="history-sidebar" id="history-sidebar">
      <div class="history-header">
        <h2>Chat History</h2>
        <button class="close-history-btn" id="close-history-btn">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="history-content">
        <ul id="history-content-list"></ul>
      </div>
      <div class="history-footer">
        <button id="history-clear-chat-btn" onclick="clearChat()">
          <i class="bi bi-trash"></i> Clear All History
        </button>
      </div>
    </div>
    <div class="container">
      <div class="main-content">
        <button class="history-toggle-btn" id="open-history-btn">
          <i class="bi bi-list"></i>
        </button>
        <div class="info-panel">
          <h2>Data Visualization</h2>
          <p>
            Fleet status and charts based on your conversation will appear here.
          </p>
        </div>
        <div class="visualization-area">
          <div class="fleet-status" id="fleet-status">
            <div class="status-card">
              <h3>Active Floats</h3>
              <p id="active-floats-value">--</p>
            </div>
            <div class="status-card">
              <h3>Files Loaded</h3>
              <p id="oceans-value">--</p>
            </div>
            <div class="status-card">
              <h3>Last Update</h3>
              <p id="last-updated-value">--</p>
            </div>
          </div>

          <div class="toggle-buttons" id="toggle-buttons" style="display: none">
            <button id="btn-map" onclick="toggleView('map')">Map</button>
            <button id="btn-profile" onclick="toggleView('profile')">
              Profile
            </button>
          </div>

          <div class="chart-section">
            <div class="zoom-controls" id="zoom-controls" style="display: none">
              <button id="zoom-in-btn" title="Zoom In">
                <i class="bi bi-zoom-in"></i>
              </button>
              <button id="zoom-out-btn" title="Zoom Out">
                <i class="bi bi-zoom-out"></i>
              </button>
            </div>
            <div class="spinner" id="spinner"></div>
            <div id="plot-container">
              <div class="plot-placeholder">
                <svg
                  viewBox="0 0 100 100"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="#ffc107"
                  stroke="#e65100"
                  stroke-width="2"
                >
                  <path
                    d="M50 10 C 61 10, 61 20, 50 20 C 39 20, 39 10, 50 10 Z M 50 20 C 50 20, 50 35, 50 35 M 40 35 C 40 35, 60 35, 60 35 M 45 30 C 45 30, 55 30, 55 30 M 35 35 C 35 35, 65 35, 65 35 M 35 35 C 30 40, 30 50, 35 55 C 40 60, 40 70, 35 75 L 35 90 L 65 90 L 65 75 C 60 70, 60 60, 65 55 C 70 50, 70 40, 65 35 Z M 35 90 C 35 90, 65 90, 65 90"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <circle cx="50" cy="15" r="2" fill="#e65100" stroke="none" />
                </svg>
                <p>
                  Your visualizations will appear here.<br />Try asking: "Show a
                  map of all floats".
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="chat-header">
          <div class="chat-title-menu">
            <div class="chat-title-trigger" id="chat-title-trigger">
              <span class="chat-icon"><i class="bi bi-robot"></i> </span>
              <h1>FloatChat AI</h1>
            </div>
            <div class="dropdown-menu" id="chat-dropdown-menu">
              <button class="dropdown-item" onclick="clearChat()">
                <i class="bi bi-arrow-clockwise"></i> Clear Chat
              </button>
              <div class="dropdown-divider"></div>
              <div class="dropdown-header">Suggested Questions</div>
              <button
                class="dropdown-item"
                onclick="useSuggestion('how many floats available in pacific regions')"
              >
                <span
                  ><i class="bi bi-geo-alt"></i> how many floats available in
                  pacific regions</span
                >
              </button>
              <button
                class="dropdown-item"
                onclick="useSuggestion('how many in atlantic')"
              >
                <span><i class="bi bi-geo-alt"></i> how many in atlantic</span>
              </button>
              <button
                class="dropdown-item"
                onclick="useSuggestion('all over the world')"
              >
                <span><i class="bi bi-globe"></i> all over the world</span>
              </button>
            </div>
          </div>

          <div class="theme-toggle-buttons">
            <button
              id="btn-default"
              class="theme-btn active"
              onclick="setTheme('default')"
              title="Default Theme"
            >
              <i class="bi bi-palette-fill"></i>
            </button>
            <button
              id="btn-light"
              class="theme-btn"
              onclick="setTheme('light')"
              title="Light Mode"
            >
              <i class="bi bi-sun-fill"></i>
            </button>
            <button
              id="btn-dark"
              class="theme-btn"
              onclick="setTheme('dark')"
              title="Dark Mode"
            >
              <i class="bi bi-moon-stars-fill"></i>
            </button>
          </div>
        </div>
        <div class="chat-window" id="chat-window"></div>
        <div class="suggestion-bar" id="suggestion-bar">
          <button onclick="useSuggestion('Show a map of all floats')">
            Show a map of all floats
          </button>
          <button onclick="useSuggestion('Show temperature profiles')">
            Show temperature profiles
          </button>
          <button onclick="useSuggestion('Show salinity profiles')">
            Show salinity profiles
          </button>
        </div>
        <div class="input-area">
          <input
            type="text"
            id="userInput"
            placeholder="Ask about ARGO float data..."
            onkeydown="if (event.key === 'Enter') sendMessage()"
          />
          <input
            type="file"
            id="fileInput"
            onchange="handleFileUpload(event)"
            multiple
          />
          <label for="fileInput" class="attach-btn" title="Attach File">
            <i class="bi bi-paperclip"></i>
          </label>
          <button
            id="micButton"
            class="mic-btn"
            title="Use Voice"
            onclick="handleVoiceInput()"
          >
            <i class="bi bi-mic-fill"></i>
          </button>
          <button id="sendButton" onclick="sendMessage()">‚û§</button>
        </div>
      </div>
    </div>

    <script>
      const userInput = document.getElementById("userInput");
      const sendButton = document.getElementById("sendButton");
      const chatWindow = document.getElementById("chat-window");
      const plotContainer = document.getElementById("plot-container");
      const spinner = document.getElementById("spinner");
      const toggleButtons = document.getElementById("toggle-buttons");
      const suggestionBar = document.getElementById("suggestion-bar");

      // --- ADDED: Zoom Control Constants ---
      const zoomControls = document.getElementById("zoom-controls");
      const zoomInBtn = document.getElementById("zoom-in-btn");
      const zoomOutBtn = document.getElementById("zoom-out-btn");

      // --- NEW: Input Area Buttons ---
      const micButton = document.getElementById("micButton");
      const fileInput = document.getElementById("fileInput");

      // --- History Sidebar Elements ---
      const historySidebar = document.getElementById("history-sidebar");
      const sidebarOverlay = document.getElementById("sidebar-overlay");
      const openHistoryBtn = document.getElementById("open-history-btn");
      const closeHistoryBtn = document.getElementById("close-history-btn");
      const historyList = document.getElementById("history-content-list");

      // --- NEW: Chat Title Dropdown Elements ---
      const chatTitleTrigger = document.getElementById("chat-title-trigger");
      const chatDropdownMenu = document.getElementById("chat-dropdown-menu");

      // --- Define the placeholder HTML as a constant ---
      const placeholderHtml = `
        <div class="plot-placeholder">
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="#ffc107" stroke="#e65100" stroke-width="2">
            <path d="M50 10 C 61 10, 61 20, 50 20 C 39 20, 39 10, 50 10 Z M 50 20 C 50 20, 50 35, 50 35 M 40 35 C 40 35, 60 35, 60 35 M 45 30 C 45 30, 55 30, 55 30 M 35 35 C 35 35, 65 35, 65 35 M 35 35 C 30 40, 30 50, 35 55 C 40 60, 40 70, 35 75 L 35 90 L 65 90 L 65 75 C 60 70, 60 60, 65 55 C 70 50, 70 40, 65 35 Z M 35 90 C 35 90, 65 90, 65 90" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="50" cy="15" r="2" fill="#e65100" stroke="none" />
          </svg>
          <p>Your visualizations will appear here.<br />Try asking: "Show a map of all floats".</p>
        </div>`;
      // --- END OF CONSTANT ---

      let lastApiResponse = null;
      // --- NEW: Speech Recognition Globals ---
      let recognition;
      let isRecognizing = false;

      // --- History Sidebar Event Listeners ---
      openHistoryBtn.onclick = () => toggleHistorySidebar(true);
      closeHistoryBtn.onclick = () => toggleHistorySidebar(false);
      sidebarOverlay.onclick = () => toggleHistorySidebar(false);

      // --- ADDED: Zoom Button Listeners ---
      zoomInBtn.onclick = () => zoomPlotly(1.2); // Zoom in by 20%
      zoomOutBtn.onclick = () => zoomPlotly(0.8); // Zoom out by 20%

      // --- NEW: Chat Title Dropdown Click Listeners ---
      chatTitleTrigger.onclick = (e) => {
        e.stopPropagation(); // Prevent click from closing it immediately
        const isVisible = chatDropdownMenu.style.display === "block";
        chatDropdownMenu.style.display = isVisible ? "none" : "block";
      };

      // Add a global click listener to close the dropdown
      document.addEventListener("click", (e) => {
        if (
          !chatTitleTrigger.contains(e.target) &&
          chatDropdownMenu.style.display === "block"
        ) {
          chatDropdownMenu.style.display = "none";
        }
      });
      // --- End of New Dropdown Listeners ---

      /**
       * Toggles the history sidebar
       * @param {boolean} [forceOpen] - Force the sidebar to open or close
       */
      function toggleHistorySidebar(forceOpen) {
        const isOpen = historySidebar.classList.contains("open");
        if (forceOpen === true || (forceOpen !== false && !isOpen)) {
          historySidebar.classList.add("open");
          sidebarOverlay.classList.add("open");
        } else {
          historySidebar.classList.remove("open");
          sidebarOverlay.classList.remove("open");
        }
      }

      /**
       * Adds a query to the history sidebar
       * @param {string} query - The user's query text
       */
      function addHistoryItem(query) {
        const li = document.createElement("li");
        const truncatedQuery =
          query.length > 30 ? query.substring(0, 27) + "..." : query;

        // Escape single quotes for the onclick attribute
        const escapedQuery = query.replace(/'/g, "\\'");

        li.innerHTML = `<a href="#" onclick="useHistorySuggestion('${escapedQuery}')">${truncatedQuery}</a>`;
        historyList.prepend(li); // Add new items to the top
      }

      /**
       * Uses a suggestion from the history list
       * @param {string} query - The query to send
       */
      function useHistorySuggestion(query) {
        useSuggestion(query);
        toggleHistorySidebar(false); // Close sidebar after clicking
      }
      // --- End of New History Functions ---

      /**
       * NEW: Sets up the SpeechRecognition API
       */
      function setupSpeechRecognition() {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          console.warn("Speech recognition not supported in this browser.");
          micButton.disabled = true;
          micButton.title = "Voice recognition not supported";
          return;
        }

        recognition = new SpeechRecognition();
        recognition.lang = "en-US";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
          isRecognizing = true;
          micButton.classList.add("is-recording");
          micButton.title = "Stop listening";
        };

        recognition.onspeechend = () => {
          recognition.stop();
        };

        recognition.onresult = (event) => {
          const speechResult = event.results[0][0].transcript;
          userInput.value = speechResult;
          // Optional: automatically send the message
          // sendMessage();
        };

        recognition.onerror = (event) => {
          console.error("Speech recognition error", event.error);
        };

        recognition.onend = () => {
          isRecognizing = false;
          micButton.classList.remove("is-recording");
          micButton.title = "Use Voice";
        };
      }

      window.onload = () => {
        appendMessage(
          "assistant",
          "Welcome to FloatChat AI! I can help you explore local ARGO float data. Try asking me about temperature, salinity, or float locations."
        );
        setupSpeechRecognition(); // NEW: Initialize speech recognition
      };

      function appendMessage(sender, text) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add(
          "message",
          sender === "user" ? "user-message" : "bot-message"
        );
        messageDiv.innerHTML = text.replace(/\n/g, "<br>");
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      async function sendMessage() {
        const query = userInput.value.trim();
        if (!query) return;

        suggestionBar.style.display = "none";

        appendMessage("user", query);
        addHistoryItem(query); // Add query to history
        userInput.value = "";
        spinner.style.display = "block";
        plotContainer.innerHTML = "";
        toggleButtons.style.display = "none";
        zoomControls.style.display = "none"; // ADDED

        try {
          const response = await fetch("http://localhost:8000/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: query }),
          });

          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          lastApiResponse = await response.json();

          appendMessage("assistant", lastApiResponse.text_response);
          handleVisualization(lastApiResponse);
        } catch (error) {
          console.error("Error fetching data:", error);
          appendMessage("assistant", "Sorry, I encountered an error.");
        } finally {
          spinner.style.display = "none";
        }
      }

      function useSuggestion(text) {
        userInput.value = text;
        sendMessage();
      }

      // --- CLEAR CHAT FUNCTION ---
      function clearChat() {
        chatWindow.innerHTML = "";
        lastApiResponse = null;

        // Clear plot and restore placeholder
        plotContainer.innerHTML = placeholderHtml;
        toggleButtons.style.display = "none";
        zoomControls.style.display = "none"; // ADDED

        // Show the original suggestion bar again
        suggestionBar.style.display = "flex";

        // Clear history list
        historyList.innerHTML = "";

        // Add the welcome message back
        appendMessage(
          "assistant",
          "Welcome to FloatChat AI! I can help you explore local ARGO float data. Try asking me about temperature, salinity, or float locations."
        );
      }

      // --- THEME SWITCHER FUNCTION ---
      function setTheme(theme) {
        const body = document.body;

        // 1. Remove all theme classes
        body.classList.remove("light-theme", "dark-theme");

        // 2. Remove 'active' from all buttons
        document.getElementById("btn-default").classList.remove("active");
        document.getElementById("btn-light").classList.remove("active");
        document.getElementById("btn-dark").classList.remove("active");

        // 3. Add the specific theme class and activate the correct button
        if (theme === "light") {
          body.classList.add("light-theme");
          document.getElementById("btn-light").classList.add("active");
        } else if (theme === "dark") {
          body.classList.add("dark-theme");
          document.getElementById("btn-dark").classList.add("active");
        } else {
          // 'default' theme
          document.getElementById("btn-default").classList.add("active");
        }

        // 4. Redraw charts with new theme colors
        if (lastApiResponse) {
          const mapActive =
            document.getElementById("btn-map").classList.contains("active");
          const profileActive =
            document
              .getElementById("btn-profile")
              .classList.contains("active");

          if (mapActive && lastApiResponse.map_data) {
            drawMap(lastApiResponse.map_data);
          } else if (profileActive && lastApiResponse.profile_data) {
            drawProfileChart(lastApiResponse.profile_data);
          }
        }
      }

      function handleVisualization(data) {
        if (data.fleet_status) {
          document.getElementById("active-floats-value").textContent =
            data.fleet_status.total_floats ?? "--";
          document.getElementById("oceans-value").textContent =
            data.fleet_status.files_loaded ?? "--";
          document.getElementById("last-updated-value").textContent =
            new Date().toLocaleTimeString();
        }

        const { map_data, profile_data, visualization_type } = data;
        const hasMapData =
          map_data && map_data.wmo_ids && map_data.wmo_ids.length > 0;
        const hasProfileData =
          profile_data && Object.keys(profile_data).length > 0;

        document.getElementById("btn-map").style.display = hasMapData
          ? "inline-block"
          : "none";
        document.getElementById("btn-profile").style.display = hasProfileData
          ? "inline-block"
          : "none";

        if (hasMapData || hasProfileData) {
          toggleButtons.style.display = "flex";
          zoomControls.style.display = "flex"; // ADDED
        } else {
          toggleButtons.style.display = "none";
          zoomControls.style.display = "none"; // ADDED
          plotContainer.innerHTML = placeholderHtml;
          return;
        }

        document
          .querySelectorAll(".toggle-buttons button")
          .forEach((btn) => btn.classList.remove("active"));
        if (visualization_type === "plot_map" && hasMapData) {
          document.getElementById("btn-map").classList.add("active");
          drawMap(map_data);
        } else if (visualization_type === "plot_profile" && hasProfileData) {
          document.getElementById("btn-profile").classList.add("active");
          drawProfileChart(profile_data);
        } else {
          if (hasMapData) {
            document.getElementById("btn-map").classList.add("active");
            drawMap(map_data);
          } else if (hasProfileData) {
            document.getElementById("btn-profile").classList.add("active");
            drawProfileChart(profile_data);
          }
        }
      }

      function toggleView(viewType) {
        if (!lastApiResponse) return;
        document
          .querySelectorAll(".toggle-buttons button")
          .forEach((btn) => btn.classList.remove("active"));
        if (viewType === "map") {
          document.getElementById("btn-map").classList.add("active");
          drawMap(lastApiResponse.map_data);
        } else if (viewType === "profile") {
          document.getElementById("btn-profile").classList.add("active");
          drawProfileChart(lastApiResponse.profile_data);
        }
      }

      function drawMap(mapData) {
        if (!mapData || !mapData.wmo_ids || mapData.wmo_ids.length === 0) {
          plotContainer.innerHTML =
            '<div class="plot-placeholder"><p>No location data available.</p></div>';
          return;
        }
        plotContainer.innerHTML = "";

        // --- UPDATED: Dynamic Theme Colors ---
        let textColor = "#1f2937";
        let landColor = "rgba(224, 224, 224, 0.6)"; // Default glass
        if (document.body.classList.contains("dark-theme")) {
          textColor = "var(--dark-text-primary)";
          landColor = "var(--dark-bg-tertiary)";
        } else if (document.body.classList.contains("light-theme")) {
          textColor = "var(--text-color)";
          landColor = "#e0e0e0";
        }
        // --- End of Update ---

        const data = [
          {
            type: "scattergeo",
            lon: mapData.lon,
            lat: mapData.lat,
            text: mapData.wmo_ids.map((id) => `Float ID: ${id}`),
            mode: "markers",
            marker: {
              size: 8,
              color: "#0066ff",
              line: { width: 1, color: "#ffffff" },
            },
          },
        ];
        const layout = {
          title: {
            text: "ARGO Float Locations",
            font: { color: textColor }, // UPDATED
          },
          geo: {
            projection: { type: "natural earth", scale: 1 }, // Added scale
            showland: true,
            landcolor: landColor, // UPDATED
            bgcolor: "rgba(0,0,0,0)",
          },
          margin: { l: 0, r: 0, t: 40, b: 0 },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
        };
        Plotly.newPlot("plot-container", data, layout, {
          responsive: true,
          displayModeBar: false,
        });
      }

      function drawProfileChart(profileData) {
        if (!profileData || Object.keys(profileData).length === 0) {
          plotContainer.innerHTML =
            '<div class="plot-placeholder"><p>No profile data available.</p></div>';
          return;
        }
        plotContainer.innerHTML = "";
        const traces = [];
        let yAxisTitle = "Pressure (dbar) ‚âà Depth (m)";
        let xAxisTitle = "";

        for (const [wmo_id, data] of Object.entries(profileData)) {
          if (data.temp) {
            xAxisTitle = "Temperature (¬∞C)";
            traces.push({
              x: data.temp.values,
              y: data.temp.pressure,
              mode: "lines",
              type: "scatter",
              name: `Temp ${wmo_id}`,
              line: { color: "#d62728" },
            });
          }
          if (data.sal) {
            xAxisTitle = "Salinity (PSU)";
            traces.push({
              x: data.sal.values,
              y: data.sal.pressure,
              mode: "lines",
              type: "scatter",
              name: `Salinity ${wmo_id}`,
              line: { color: "#1f77b4" },
            });
          }
        }

        // --- UPDATED: Dynamic Theme Colors ---
        let textColor = "#1f2937";
        let gridColor = "rgba(0, 0, 0, 0.1)"; // Default glass
        if (document.body.classList.contains("dark-theme")) {
          textColor = "var(--dark-text-primary)";
          gridColor = "rgba(255, 255, 255, 0.1)";
        } else if (document.body.classList.contains("light-theme")) {
          textColor = "var(--text-color)";
          gridColor = "var(--border-color)";
        }
        // --- End of Update ---

        const layout = {
          title: {
            text: "ARGO Float Profile",
            font: { color: textColor }, // UPDATED
          },
          xaxis: {
            title: xAxisTitle,
            gridcolor: gridColor, // UPDATED
            color: textColor, // UPDATED
          },
          yaxis: {
            title: yAxisTitle,
            autorange: "reversed",
            gridcolor: gridColor, // UPDATED
            color: textColor, // UPDATED
          },
          margin: { l: 60, r: 20, t: 40, b: 50 },
          showlegend: true,
          legend: {
            x: 1,
            xanchor: "right",
            y: 1,
            font: { color: textColor }, // UPDATED
          },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
        };
        Plotly.newPlot("plot-container", traces, layout, {
          responsive: true,
          displayModeBar: false,
        });
      }

      /**
       * NEW: Zooms the active Plotly chart
       * @param {number} scaleFactor - Factor to zoom by (e.g., 1.2 for zoom in, 0.8 for zoom out)
       */
      function zoomPlotly(scaleFactor) {
        const plotDiv = document.getElementById("plot-container");
        if (!plotDiv.layout) return; // No plot to zoom

        const currentLayout = plotDiv.layout;
        const newLayout = {};

        // Check if it's a map (has 'geo')
        if (currentLayout.geo) {
          const currentScale = currentLayout.geo.projection.scale || 1;
          newLayout["geo.projection.scale"] = currentScale * scaleFactor;
        }
        // Check if it's a profile chart (has 'xaxis' and 'yaxis')
        else if (currentLayout.xaxis && currentLayout.yaxis) {
          // Check for existing ranges (autorange might be true)
          const xaxis = currentLayout.xaxis;
          const yaxis = currentLayout.yaxis;

          // If no range is set (e.g., autorange), we can't scale it.
          // Plotly.relayout will set the ranges after the first render.
          if (!xaxis.range || !yaxis.range) return;

          // Calculate new range by scaling from the center
          const xCenter = (xaxis.range[0] + xaxis.range[1]) / 2;
          const xRange = (xaxis.range[1] - xaxis.range[0]) / 2;
          newLayout["xaxis.range"] = [
            xCenter - xRange / scaleFactor,
            xCenter + xRange / scaleFactor,
          ];

          const yCenter = (yaxis.range[0] + yaxis.range[1]) / 2;
          const yRange = (yaxis.range[1] - yaxis.range[0]) / 2;
          newLayout["yaxis.range"] = [
            yCenter - yRange / scaleFactor,
            yCenter + yRange / scaleFactor,
          ];
        }

        Plotly.relayout("plot-container", newLayout);
      }

      /**
       * NEW: Handles the voice input button click
       */
      function handleVoiceInput() {
        if (!recognition) return;

        if (isRecognizing) {
          recognition.stop();
        } else {
          try {
            recognition.start();
          } catch (e) {
            console.error("Error starting recognition: ", e);
            isRecognizing = false;
            micButton.classList.remove("is-recording");
          }
        }
      }

      /**
       * NEW: Handles the file attachment
       * @param {Event} event - The file input change event
       */
      function handleFileUpload(event) {
        const files = event.target.files;
        if (!files.length) {
          return;
        }

        const fileNames = Array.from(files)
          .map((file) => file.name)
          .join(", ");

        // Placeholder: Show an alert with file names
        // You can replace this with your actual upload logic
        alert(`File(s) selected: ${fileNames}`);
        appendMessage(
          "assistant",
          `You selected ${fileNames}. (Upload not implemented)`
        );

        // You would typically send this file to your backend
        // For example, using FormData:
        /*
        const formData = new FormData();
        for (const file of files) {
          formData.append('files', file);
        }

        // Example of sending to backend
        fetch('http://localhost:8000/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          console.log('Upload successful', data);
          appendMessage('assistant', `Uploaded ${fileNames}.`);
        })
        .catch(error => {
          console.error('Upload error:', error);
          appendMessage('assistant', `Sorry, I couldn't upload ${fileNames}.`);
        });
        */

        // Clear the file input value so the user can select the same file again
        event.target.value = null;
      }
    </script>
  </body>
</html>
